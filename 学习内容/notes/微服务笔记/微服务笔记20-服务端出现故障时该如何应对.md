# 三种故障类型：
- 集群故障：代码出现bug,集群都会出现故障，不能对外提供服务。
- 单IDC故障：电缆被挖断，或者机房出现不可抗拒的问题
- 单机故障：集群中单个机器出现问题。影响调用失败的概率，影响整个系统的成功率。

# 集群故障
一种类型是bug 导致，另外一种是流量冲击，超过系统的最大承载能力。
集群故障思路良好总限流与降级
## 限流
限制流量。系统承载的流量是根据集群规模的大小固定的。
根据系统的最大容量，设置一个阈值，超过这个阈值的请求会被自动抛弃，保证服务的最大限度得保证系统提供的服务正常。

一个微服务操作很可能不止提供一个服务，呢么容易出现一个服务同一时刻请求量很大的情况。
针对系统中的每个服务请求来你给也设置一个阈值，超过这个阈值，请求抛弃，不让该服务影响到其他服务的调用。

根据两个指标来衡量服务的请求量。
- QPS 每秒的请求量：不同的QPS 因为不同的服务的响应快慢不同，系统承载的 QPS相差很大。
- 工作线程数：一般选择线程数来作为限流的指标。给系统设置一个总的最大工作线程数，以及单个服务的最大线程数量，无论负载超过哪一个指标都会被限流，保证整个系统的可用。
## 降级

降级：通过停止系统中的某些功能，保证系统整体的可用性。

可行的方案，是通过开关来实现。通过开关来达到业务逻辑的执行不执行。
开关一般用在两个地方。
- 新增的业务逻辑： 业务不成熟，那么通过开关进行调控。
- 依赖的服务或者资源： 依赖出问题，可以通过开关进行降低调整。

降级分为三级 ：
- 一级降级： 业务影响最小的降级，可以设置成自动降级。
- 二级降级： 对业务有一定的影响，采用人为措施。
- 三级降级：对业务有较大影响的降低。一般不希望采取。
# 单IDC故障
采用多IDC部署的好处是当有一个IDC发生故障的时候，可以把服务切换到正常的IDC操作。
## DNC解析切换流量访问
把请求的访问域名解析从一个IDC访问到另外的IDC
## 基于RPC分组流量切换
路由分组时，不咋把流量分配到故障的IDC中直接切换到其他的分组中。

# 单机故障

单机出现问题，一般采用有效方法是自动重启。 设定一个阈值，认为机器有问题 达到重启。再加入到集群中。

要防范网络抖动造成接口超时出发自动重启。采集数据 设定重启的条件。

设定重启的数量。同一时刻可重启的单价数量不要占据整个集群中很大的比例，一般不建议超过10%。

还有可以设定单机重启的次数。防止其他问题导致程序一直在重启。

尽量让故障自动化处理，这样可以减少故障影响的时间，能达到对用户很少的影响。


