# 注册中心怎么存储服务信息
存储信息那么需要知道具体要存储的内容，存储内容一般包含节点信息，失败尝试的次数，请求的结果等需信息，大部分用json来存储。
除次基础信息之后还有其他类新信息，这种信息一般用分组来总结。
比如 核心业务与非核心，机房的不同维度，线上环境与测试环境。
服务内容包含 分组 、服务名及节点名称。节点又包含节点地址与节点其他信息。
![kv存储格式](https://upload-images.jianshu.io/upload_images/4237685-f4cf06eb0ffb5030.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

我们原先说过四个流程：服务提供者 注册流程，与反注册。消费者查询与订阅变更流程。
# 注册中心如何工作
## 注册节点。
1. 检查是否在我们设置的白名单内，防止环境的混乱。
2. 要注册的Cluster服务的接口名，是否存在。
3. 检查Service 分组是否存在。
4. 最后将节点信息添加到对应的Service中和Cluster中。
## 反注册
1. 查看Service 服务的分组是否存在。
2.查看Cluter 服务的接口名是否存在。
3. 删除对应下面的节点名称
4. 更新Cluster下面的sign值。**这个sign是什么？**
可以画成流程图
## 查询节点信息--消费者使用
1.从本机服务内存查找，没有在进行下一步，一般放到内存中的原因是服务一般不是时刻变化的。不一定一直去获取最新的数据列表
2.本地快照中查找。没有再进行下一步。本地快照是保存着一份来自注册中心的信息快照，防止本地服务挂掉之后重启内存中没有消息列表，在调用注册中心失败，那么就获取不到信息了。
## 订阅服务变更
1. 从注册中心获得服务 的信息后，就订阅了服务的变化，在本地保存Cluster的sign值
2. 服务消费者隔一段时间调用getSign函数，比较sign的值，不一致那么就拉去新的节点信息，并更新localcache与snapshot 本地快照。
---
上面是通用的流程但是还有其他问题需要解决。
##  多注册中心。
消费者能够从多个中心订阅服务，服务提供者能同时向多个注册中心注册服务。
## 并行订阅服务
订阅多个注册中心的服务，那么如果采用的是串行的方式容易造成启动链接时间浪费。采取并行化的方式，一个服务采用一个线程处理。其中一个线程出现问题也不会影响到其他服务的启动。
## 批量反注册服务
反注册是为了让僵尸节点从服务器上去掉，那么我们最好采用批量的方式来反注册僵尸节点。这样容易清理完全。
## 服务变更信息增量
消费者一般启动的时候，除了查询列表信息做初始化链接，还会订阅服务的变更。每隔一段时间进行本地与线上的sign值对比，不一致就更新消费者本地的节点信息。
但是如果数据量大，或者网络不稳定，容易导致带宽被打满，那么就会导致更新失败，。
那么我们可以选择增量更新，只取变化的节点信息，减少拉去的数据量。减少网络风暴的出现。


