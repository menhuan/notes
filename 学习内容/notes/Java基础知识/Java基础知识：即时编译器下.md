# 分解profile

收集的profile具体作用是？

C2可以根据收集来的数据进行猜测，假设接下来的操作会根据收集的profile进行执行，从而触发优化动作。

## 基于分支profile的优化

编译器对于分支跳转情况不多，进行优化一般都是将未执行过的**分支代码减掉**，避免编译不会用到的代码。

还会根据分支计算程序执行的路径概率，让编译器提前去优化概率较高的代码。

分支计算过程中会遇到各个判断，判断代码是否要执行，进来来精简代码，达到优化的目的。

## 基于类型profile的优化

基于类型的分支优化也是作出假设，达到控制流以及数据流，对程序进行优化。

## 去优化

上面两条规则如果假设失败，那么就会执行到这一步。从执行即时编译器生成的机器码 切换回解释执行。

去优化的会导致生成的代码和原本的字节码差异非常之大。

优化过程中，需要将当前机器码执行状态转换至某一字节码之前的执行状态，并从该字节码开始执行。

编译器需要在编译的过程中记录好两者之间的映射关系。

映射关系建立好之后，虚拟机采用OSR技术开始动态替换栈上的内容，并在目标字节码处开始执行。

调用优化方式有三种。

- 去优化与优化无关，机器码不需要重新优化，而是保留，下次直接调用。
- 去优化与静态分析有关，可以不保留这一份机器码，可以不经过profile直接编译。
- 与基于profile的激进优化有关，那么生成的机器码不保留这一份机器码，重新收集程序的profile。

失败的时候，往往代表程序执行状态发生改变，那么需要重新更正收集的profile，更好的反映新的程序执行状态。
