# 网络基础了解

## 网络模型

OSI模型可以了解下，暂时不作为总结内容。属于7层构建内容。

### TCP/IP模型

重点了解这个模型。四层模型，将上面7层模型内容作了精简。

- 应用层：负责向用户提供的一组网络，如HTTP,FTP等内容。
- 传输层：传输层一般是我们所说的网络协议TCP,UDP等数据包。
- 网络层：负责网络内容的包装如**IP**，ICMP等。
- 网络接口层：负责网络包在物理网络中的传输，比如MAC地址的寻址，网卡传输等。

## 网络栈

在网络栈中，就是将我们的数据按照一定的格式进行包装。比如我们要传输JSON数据内容。

- 应用层：在这里进行包装比如HTTP,RPC内容的包装。这里还是属于数据内容。当然上面的HTTP和RPC不是必要的，取决于自己的传输方式。
- 传输层：上面说我们传输数据需要采用网络协议，常用的HTTP都是采用Socket，这里我们使用在应用层的数据包上增加TCP头。如果是UDP那么增加UDP的头部。
- 网络层:这里是指定IP地址，在上面的数据上再增加IP头。
- 网络接口：在IP数据包的基础上增加帧头与帧尾。

### 每一层都会增加数据内容，导致长度增加，那在网络传输的时候是怎么解决的呢？

网络配置中有一个最大的传输单元MTU。规定了IP包大小。

网络传输的数据内容超过这个大小，那么就会行进数据分片，保证分片后的IP包不大于MTU设置的大小。

设置MTU越大，需要的分包就越少，网络吞吐能力就越好。

## Linux的网路栈

- 最上层的应用程序，通过系统调用，跟套接字进行交互。
- 套接字下面就是刚才所说的应用层，传输层，网络层，网络接口层。
- 最底层，网卡驱动程序以及物理网卡设备

网卡：接收与发送网络包的基本设备。

启动，网卡通过驱动程序注册到系统中。

收发过程中：内核通过终端与网卡进行交互。

## Linux 网络收发流程

物理网卡，虚拟网卡与此有些不同。

### 接收过程

#### 网卡处理流程

1. 一个网络帧到达网卡，网卡通过DMA过程将其放到收包队列中。
2. 通过硬中断，告知终端处理程序收到网络包。
3. 网卡终端处理程序给网络帧分配内核数据结构sk_buff,并将其拷贝到sk_buff缓冲区中。
4. 通过软中断，通知内核收到了网络帧。

#### 内核处理流程

1. 内核协议栈从缓冲区取出网络帧，通过网络协议帧从下到上处理。
2. 链路层检查报文是否合法，找出上层的IP协议IPV4还是IPV6,去掉增加的帧头与帧尾。
3. 网络层，取出IP头，判断下一层的走向，是发送到上一层，还是进行数据转发。
4. 如果是本地的，会取出上层的协议类型，将IP头部取出来。转交给传输层进行处理。
5. 传输层取出TCP或者UDP层数据，根据四目原则找到对应的Socket。四目指的是：<源IP，源端口，目的IP，目的端口>
6. 将数据拷贝到Socket的缓冲层中。
7. 应用程序使用Socket接收数据，读取到最新的数据。

### 发包流程

与接收包流程类似，将上面内容反转过来，并且判断MTU与发送的内容大小做对比，如果超过MTU的大小，需要进行分包发送。

