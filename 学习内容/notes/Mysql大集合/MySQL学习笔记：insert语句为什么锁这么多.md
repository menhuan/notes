# Insert 语句锁

了解插入语句的思考。

## insert...select 语句

在可重复读的隔离级别下， binlog_format =statement执行。

执行这类语句会在查询的表会锁住访问的资源。

执行这类语句，读取该表再把该表数据插入该表中，这种情况就是一边遍历数据，一边更新数据的情况。

读到刚才新插入的记录，也参与计算，语义操作就与想要的结果不符合。

## Insert 唯一键冲突

在可重复读的隔离级别下，发生唯一键冲突的时候，并不是简单的报错返回，还给冲突的索引加锁，包含索引上的锁，与next-lock读锁。

解决主键约束错误，或者主键约束错误，在sql语句中可以使用

```Java
insert into t values () on duplicate key update 语句;
```

duplicate key 语句是为了插入语句在执行的时候出现唯一键约束，执行后面的更新语句。

