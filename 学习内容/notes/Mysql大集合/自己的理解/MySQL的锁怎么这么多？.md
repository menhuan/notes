# MySQL中的锁

不同的语言中我们都会看到锁的存在，锁是用来保证并发操作共享数据的正确性。

MySQL中为了挺高并发处理，同样也存在锁机制。今天我们就来了解小MySQL的锁都有什么。

## MySQL的锁级别

在MySQL中根据锁的不同粒度，可以将锁分为**全局锁,表锁,行锁**。

![锁粒度](http://jikelearn.cn/img/20201012073840.png)

全局锁锁的粒度是最大的，同样的并发能力也是最弱的。
行锁锁的粒度是最小的，同样的并发能力是最强的。

其实还有一种**间隙锁**，但这种锁是用来解决幻读问题的，存在于隔离级别是可重复度的情况下才会存在。本次暂不进行分析。

## MySQL的全局锁

全局锁就是对整个数据库进行加锁，全局锁加锁后会让整个数据库处于只读的状态，不能进行其他增删改操作。

### 全局锁的使用原因

全局锁使用后，整个系统处于只读的状态，这样的全局锁基本上用于**数据库备份状态**，还有从库也是只读状态哦。

**为什么数据库备份的时候要进行加锁呢？**

我们在使用数据库备份的时候进行逻辑备份，备份完一个表，再备份另外一个表。

现在有个人进行消费，流水表增加一笔流水记录，然后订单表里面多了一个订单。

这时候如果备份先备份了订单表，再备份流水表，你会发现有了流水，但没有订单记录。

这就出现了数据不一致的情况。所以备份的时候一定要进行锁表操作。

**加全局锁是为了保证备份数据的一致性。**

### 全局锁的使用方式

了解了为什么要用全局锁，那在MySQL中怎么使用全局锁呢？有两种方式。

- 全局数据库设置为只读`set global readonly=true`
- 使用FTWRL(FLush tables with read lock)

这两种方式不建议使用 `set global readonly=true`,有两个考虑

1. 我们经常会把数据库设置为只读用来判断是主库还是从库（从库一般只提供读的能力）。
2. 两个异常处理的机制不同，FTWRL的机制如果有异常发生，那么数据库会自动的释放全局锁，保证数据库能处于正常的状态，而readonly之后，除非手动释放，否则整个数据库会一直处于只读状态。

最终给数据库加全局锁时，采用FTWRL(Flush tables with read lock)是好的方式，原因请看上面两个考虑。

## MySQL的表级锁

Mysql的表级锁可以分为两种，表锁和元数据锁(meta data lock**简称MDL**).

### 元数据锁MDL

DML锁的作用是用来保证读写的正确性。


### 表级锁


## MySQL的行锁

